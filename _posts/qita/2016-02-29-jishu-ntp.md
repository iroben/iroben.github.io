---
layout: post
title: 服务器时间同步问题
category: 其它
keywords: 服务器时间 ntpd
---

昨天准备粗去的，结果突然接到经理电话说外面的视频都放不了，这周末整的，最近没有更新什么东西啊，怎么会放不了啊，难道是用户访问量太多了，服务器扛不住了，于是赶紧登录服务器看下，`top`看了下，服务器很正常啊，数据库访问也正常，怎么可能放不了啊，然后就自己写个测试程序生成一个私有资源的url，一访问，果然好像有问题

	{
	    	"error":"token out of date"
	}
	
这怎么可能，`token `的`expires`设置的是60s，我从生成url到执行肯定不会超过`2s`的，应该绝对不会超时的，后来我设置成`100s`，OK了，可以访问了，先这样用着，明天到公司看下。

终于星期一了，“开心”的上班去了，今天起的格外早，以前 8:40 到公司的我，今天居然 8:15 就到了，啧啧啧，真是个敬业的**好青年**

赶紧看昨天的问题，在本地先写了个程序生成私有url访问地址，等了10s再访问，可以正常访问，上传到七牛的主机是再跑一下这个程序，果然出现了昨天那个问题，说明程序是正常的，再对比下PHP的时间，用最快的手速在本地终端和远程终端执行

	php -r "echo date('Y-m-d H:i:s');"

结果发现七牛主机比本地主机慢了60s，应该是这个问题了，好奇怪，服务器一直没有重起过了，怎么会慢60s呢，先不管，先同步下时间再说

	ntpdate asia.pool.ntp.org
		
再用最快的速度执行下

	php -r "echo date('Y-m-d H:i:s');"
	
两边时间一样了，再跑下测试程序生成的url，也正常了，为了防止类似问题再出现，赶紧装了个`ntpd`服务

	yum install ntpd

在`/etc/rc.local`加个`/etd/init.d/ntpd start`，启动服务`service ntpd start`